rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== HELPER FUNCTIONS =====
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin (by email)
    // Add your admin email addresses to this list
    // Note: Firebase Auth emails are case-insensitive, using .lower() for comparison
    function isAdmin() {
      return isAuthenticated() && 
        request.auth.token.email.lower() in [
          'admin@atfactoryprice.com', 
          'hello@atfactoryprice.com',
          'atfactorypriceonline@gmail.com'
          // Add more admin emails here as needed
        ];
    }
    
    // Check if this is the first write (create)
    function isCreate() {
      return resource == null;
    }
    
    // Check if field is unchanged
    function fieldUnchanged(field) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny([field]);
    }
    
    // ===== USER COLLECTION =====
    match /users/{userId} {
      // Users can read their own data
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own document
      allow create: if isOwner(userId);
      
      // Users can update their own document, but sponsorId is write-once
      allow update: if isOwner(userId) && (
        // If sponsorId already exists, it cannot be changed
        !('sponsorId' in resource.data) || 
        fieldUnchanged('sponsorId')
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ===== MLM NETWORK COLLECTION =====
    match /mlm_network/{userId} {
      // Users can read their own network entry
      allow read: if isOwner(userId) || isAdmin();
      
      // Only Cloud Functions can write (no client writes)
      allow write: if false;
    }
    
    // ===== MLM WALLETS COLLECTION =====
    match /mlm_wallets/{userId} {
      // Users can only read their own wallet
      allow read: if isOwner(userId) || isAdmin();
      
      // NO CLIENT WRITES - all wallet operations through Cloud Functions
      allow write: if false;
    }
    
    // ===== MLM COMMISSIONS COLLECTION =====
    match /mlm_commissions/{commissionId} {
      // Users can read their own commissions
      allow read: if isAuthenticated() && (
        resource.data.beneficiaryId == request.auth.uid || 
        resource.data.buyerId == request.auth.uid ||
        isAdmin()
      );
      
      // NO CLIENT WRITES - commissions created by Cloud Functions only
      allow write: if false;
    }
    
    // ===== MLM COMMISSION RULES COLLECTION =====
    match /mlm_commission_rules/{ruleId} {
      // Anyone authenticated can read rules
      allow read: if isAuthenticated();
      
      // Only admin can write rules
      allow write: if isAdmin();
    }
    
    // ===== MLM CONFIG COLLECTION =====
    match /mlm_configs/{configId} {
      // Anyone authenticated can read config
      allow read: if isAuthenticated();
      
      // Only admin can write config
      allow write: if isAdmin();
    }
    
    // ===== MLM PAYOUT REQUESTS COLLECTION =====
    match /mlm_payout_requests/{requestId} {
      // Users can read their own payout requests
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // Users can create payout requests through Cloud Functions only
      // Direct client writes not allowed for security
      allow create: if false;
      
      // Only admin can update (approve/reject)
      allow update: if isAdmin();
      
      // No deletes
      allow delete: if false;
    }
    
    // ===== MLM AUDIT LOGS COLLECTION =====
    match /mlm_audit_logs/{logId} {
      // Only admin can read audit logs
      allow read: if isAdmin();
      
      // No client writes - only Cloud Functions
      // Logs are immutable once created
      allow write: if false;
    }
    
    // ===== PHASE 7: MLM RISK FLAGS COLLECTION =====
    match /mlm_risk_flags/{flagId} {
      // Only admin can read risk flags
      // Users should NOT see their own risk flags
      allow read: if isAdmin();
      
      // No client writes - only Cloud Functions create flags
      allow create: if false;
      
      // Only admin can update (review, resolve)
      allow update: if isAdmin();
      
      // No deletes - flags are permanent record
      allow delete: if false;
    }
    
    // ===== PHASE 7: MLM ANALYTICS DAILY COLLECTION =====
    match /mlm_analytics_daily/{dateKey} {
      // Only admin can read analytics
      allow read: if isAdmin();
      
      // No client writes - only Cloud Functions aggregate
      allow write: if false;
    }
    
    // ===== ORDERS COLLECTION =====
    match /orders/{orderId} {
      // Users can read their own orders
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.buyerId == request.auth.uid ||
        resource.data.customerId == request.auth.uid ||
        isAdmin()
      );
      
      // Users can create orders
      allow create: if isAuthenticated();
      
      // Users can update their own pending orders, admin can update any
      allow update: if isAuthenticated() && (
        (resource.data.userId == request.auth.uid && resource.data.status == 'pending') ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ===== WALLETS COLLECTION (Legacy - redirect to mlm_wallets) =====
    match /wallets/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false;
    }
    
    // ===== MLM WITHDRAWALS COLLECTION (Legacy) =====
    match /mlm_withdrawals/{withdrawalId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }
    
    // ===== REFERRAL CODES LOOKUP COLLECTION =====
    // Public read-only collection for referral code validation during signup
    match /referral_codes/{codeId} {
      // Anyone can read (needed for signup validation)
      allow read: if true;
      
      // Authenticated users can create/update their own referral code entry
      // Using simpler rule: any authenticated user can write if userId matches their auth uid
      allow write: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // No deletes
      allow delete: if false;
    }
    
    // ===== PRODUCTS COLLECTION =====
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      
      // Only admin can write
      allow write: if isAdmin();
    }
    
    // ===== CATEGORIES COLLECTION =====
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ===== PHASE 8: MLM POINTS WALLET COLLECTION =====
    match /mlm_points_wallet/{userId} {
      // Users can only read their own points wallet
      allow read: if isOwner(userId) || isAdmin();
      
      // NO CLIENT WRITES - all points operations through Cloud Functions
      allow write: if false;
    }
    
    // ===== PHASE 8: MLM POINTS LEDGER COLLECTION =====
    match /mlm_points_ledger/{entryId} {
      // Users can read their own points transactions
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      
      // NO CLIENT WRITES - all ledger entries created by Cloud Functions
      allow write: if false;
    }
    
    // ===== GOOGLE SHEETS SYNC CACHE =====
    match /sheets_cache/{cacheId} {
      // Anyone authenticated can read cached data
      allow read: if isAuthenticated();
      
      // Only Cloud Functions write cache
      allow write: if false;
    }
    
    // ===== SHEETS CACHE - PRODUCTS =====
    match /sheets_cache_products/{productId} {
      // Anyone can read cached products
      allow read: if true;
      
      // Only Cloud Functions write
      allow write: if false;
    }
    
    // ===== SHEETS CACHE - CATEGORIES =====
    match /sheets_cache_categories/{categoryId} {
      // Anyone can read cached categories
      allow read: if true;
      
      // Only Cloud Functions write
      allow write: if false;
    }
    
    // ===== SHEETS CACHE - MLM CONFIGS =====
    match /sheets_cache_mlm_configs/{configId} {
      // Authenticated users can read MLM configs from sheets
      allow read: if isAuthenticated();
      
      // Only Cloud Functions write
      allow write: if false;
    }
    
    // ===== SHEETS CACHE - REWARD SCHEMES =====
    match /sheets_cache_reward_schemes/{schemeId} {
      // Authenticated users can read reward schemes
      allow read: if isAuthenticated();
      
      // Only Cloud Functions write
      allow write: if false;
    }
    
    // ===== SHEETS SYNC LOGS =====
    match /sheets_sync_logs/{logId} {
      // Only admin can read sync logs
      allow read: if isAdmin();
      
      // Only Cloud Functions write logs
      allow write: if false;
    }
    
    // ===== INTERNAL FORMS COLLECTION =====
    match /internal_forms/{formId} {
      // Admin can read all forms, employees can read forms they have access to
      allow read: if isAdmin();
      
      // Only admin can create/update/delete forms
      allow write: if isAdmin();
    }
    
    // ===== FORM SUBMISSIONS COLLECTION =====
    match /form_submissions/{submissionId} {
      // Users can read their own submissions, admin can read all
      allow read: if isAuthenticated() && (
        resource.data.submittedBy == request.auth.uid ||
        isAdmin()
      );
      
      // Authenticated users can create submissions
      allow create: if isAuthenticated() && 
        request.resource.data.submittedBy == request.auth.uid;
      
      // No updates or deletes
      allow update, delete: if false;
    }
    
    // ===== PAYMENT WEBHOOK LOGS =====
    // Audit trail for all payment webhook calls
    match /payment_webhook_logs/{logId} {
      // Only admin can read logs (via Cloud Function)
      allow read: if isAdmin();
      
      // Only Cloud Functions can write logs
      // NO CLIENT WRITES - ensures audit trail integrity
      allow write: if false;
    }
    
    // ===== USER ADDRESSES SUBCOLLECTION =====
    match /users/{userId}/addresses/{addressId} {
      // Users can manage their own addresses
      allow read, write: if isOwner(userId);
      
      // Admin can view for support
      allow read: if isAdmin();
    }
    
    // ===== HOMEPAGE SLIDER CONFIGURATION =====
    match /site_config/homepage_slider {
      // Anyone can read slider config
      allow read: if true;
      
      // Only admin can update
      allow write: if isAdmin();
    }
    
    match /site_config/homepage_slider/slides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ===== DELIVERY PIN CODES CONFIGURATION =====
    match /delivery_config/{configId} {
      // Anyone can read delivery config
      allow read: if true;
      
      // Only admin can update
      allow write: if isAdmin();
    }
  }
}
